# Production deployment - runs both MediaMTX and mediamtx-connect
# Usage: docker compose up -d
services:
  mediamtx:
    image: bluenviron/mediamtx:1.11.3
    container_name: mediamtx
    restart: unless-stopped
    volumes:
      - ./mediamtx.yml:/mediamtx.yml:ro
      - ${MEDIAMTX_RECORDINGS_DIR:-./recordings}:/recordings
    networks:
      - mtx
    ports:
      - '8554:8554' # RTSP
      - '8890:8890/udp' # WebRTC/ICE UDP
      - '1935:1935' # RTMP
      - '8888:8888' # HLS
      - '8889:8889' # WebRTC HTTP
      - '9997:9997' # API

  mediamtx-connect:
    # image: ghcr.io/bcanfield/mediamtx-connect:latest
    build: . # Uncomment to build from source
    depends_on:
      - mediamtx
    container_name: mediamtx-connect
    restart: unless-stopped
    networks:
      - mtx
    volumes:
      - ${MEDIAMTX_RECORDINGS_DIR:-./recordings}:/recordings
      - mediamtx-connect-data:/app/prisma
    ports:
      - '3000:3000'
    healthcheck:
      test: [CMD, curl, -f, 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mtx:
    name: mtx

volumes:
  mediamtx-connect-data:
