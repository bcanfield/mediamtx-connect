services:
  mediamtx:
    image: bluenviron/mediamtx:1.11.3
    container_name: mediamtx
    restart: unless-stopped
    environment:
      - MTX_API=yes
      - MTX_APIADDRESS=:9997
      - MTX_RECORD=yes
      - MTX_RECORDPATH=/recordings/%path/%Y-%m-%d_%H-%M-%S
      - MTX_HLS=yes
      - MTX_HLSADDRESS=:8888
    volumes:
      - ${MEDIAMTX_RECORDINGS_DIR:-./recordings}:/recordings
    networks:
      - mtx
    ports:
      - "8554:8554"      # RTSP
      - "8890:8890/udp"  # WebRTC/ICE UDP
      - "1935:1935"      # RTMP
      - "8888:8888"      # HLS
      - "8889:8889"      # WebRTC HTTP
      - "9997:9997"      # API
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9997/v3/paths/list"]
      interval: 30s
      timeout: 10s
      retries: 3

  mediamtx-connect:
    image: ghcr.io/bcanfield/mediamtx-connect:latest
    # Uncomment below to build from source instead
    # build:
    #   context: ./
    depends_on:
      mediamtx:
        condition: service_healthy
    container_name: mediamtx-connect
    restart: unless-stopped
    networks:
      - mtx
    volumes:
      - ${MEDIAMTX_RECORDINGS_DIR:-./recordings}:/recordings
      - mediamtx-connect-data:/app/prisma
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Uncomment to run demo streams for testing
  # demo-streams:
  #   tty: true
  #   build:
  #     context: ./dev
  #   depends_on:
  #     - mediamtx
  #   container_name: demo-streams
  #   restart: unless-stopped
  #   networks:
  #     - mtx

networks:
  mtx:
    name: mtx

volumes:
  mediamtx-connect-data:
